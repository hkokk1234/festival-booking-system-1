<!doctype html>
<html lang="el">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Organizer · Performances</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='8' fill='%23111827'/%3E%3Ctext x='8' y='48' font-size='40'%3E🎫%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--border:#1f2937;--brand:#38bdf8;--btn:#0b3750;}
      body{margin:0;background:var(--bg);color:#e5e7eb;font:16px/1.5 system-ui,Segoe UI,Roboto}
      .container{max-width:1200px;margin:2rem auto;padding:0 1rem}
      .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
      .toolbar{display:flex;justify-content:space-between;align-items:end;margin-bottom:1rem}
      .title{margin:0;font-size:1.6rem}
      input,select,textarea{padding:.55rem .7rem;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
      textarea{min-height:70px}
      button{padding:.55rem .9rem;border-radius:12px;border:1px solid var(--border);background:var(--btn);color:#e5e7eb;cursor:pointer}
      button:hover{filter:brightness(1.05)}
      button[disabled]{opacity:.6;cursor:not-allowed}
      a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
      .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem}
      .card h3{margin:.15rem 0 .4rem;font-size:1.15rem}
      .meta{color:var(--muted);font-size:.92rem;margin:.1rem 0}
      .badge{display:inline-block;background:#0b3750;border:1px solid #124b67;color:var(--brand);padding:.15rem .55rem;border-radius:999px;font-size:.75rem}
      .msg{margin-top:.5rem}
      .msg.error{color:#fca5a5}.msg.success{color:#86efac}
      .small{font-size:.9rem}
      .between{justify-content:space-between}
      .muted{color:var(--muted)}
    </style>
  </head>
  <body>
    <main class="container">
      <div class="toolbar">
        <h1 class="title">Organizer · Performances</h1>
        <div class="row">
          <a class="small" href="/">← Αρχική</a>
          <!-- ΝΕΟ ΚΟΥΜΠΙ REDIRECT -->
          <button id="btn-festivals" title="Μετάβαση στη σελίδα Festivals">Festivals</button>
          <button id="btn-logout" title="Logout">Logout</button>
        </div>
      </div>

      <div class="row" style="gap:.6rem;margin-bottom:.8rem">
        <input id="q" type="search" placeholder="Αναζήτηση τίτλου/είδους/καλλιτέχνη..." />
        <select id="status">
          <option value="ALL" selected>ALL</option>
          <option value="CREATED">CREATED</option>
          <option value="PENDING">PENDING</option>
          <option value="SUBMITTED">SUBMITTED</option>
          <option value="APPROVED">APPROVED</option>
          <option value="ACCEPTED">ACCEPTED</option>
          <option value="FINAL_SUBMITTED">FINAL_SUBMITTED</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="REJECTED">REJECTED</option>
          <option value="CANCELLED">CANCELLED</option>
        </select>
        <button id="btn-load">Φόρτωση</button>
      </div>

      <div id="msg" class="msg"></div>
      <div id="list" class="grid"></div>
    </main>

    <script src="/js/config.js"></script>
    <script>
  const CFG = window.APP_CONFIG || {};
  const API_BASE = (CFG.API_BASE || "/api").replace(/\/+$/,"");

  // ---- FIX: καθάρισε τυχόν status από το PERF_PATH ----
  const RAW_PERF_PATH = (CFG.RESOURCES && CFG.RESOURCES.PERFORMANCES) || "/performances";
  const PERF_PATH = RAW_PERF_PATH
      .replace(/\/+$/,'')
      .replace(/\/(approved|pending|submitted|created|accepted|final_submitted|confirmed|rejected|all)$/i,''); // βγάλε τυχόν status

  // ====== helpers ======
  const $ = s => document.querySelector(s);
  const setMsg = (t, kind) => { const el=$("#msg"); el.textContent=t||""; el.className="msg"+(kind?" "+kind:""); };
  const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const authHeader = () => { const t=localStorage.getItem("access_token"); return t?{Authorization:"Bearer "+t, Accept:"application/json"}:{ Accept:"application/json" }; };

  // CORS-safe credentials
  function credsFor(url){ try{const u=new URL(url,location.origin); return u.origin===location.origin?"same-origin":"omit";}catch{return "omit";} }

  // JWT role check
  function decodeJwtPayload(token){
    try{
      const p = token.split(".")[1];
      const b64 = p.replace(/-/g, "+").replace(/_/g, "/");
      const json = decodeURIComponent(atob(b64).split("").map(c => "%" + ("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""));
      return JSON.parse(json);
    }catch{ return null; }
  }
  function ensureOrganizer(){
    const t = localStorage.getItem("access_token");
    if (!t){ location.href="/login.html"; return false; }
    let roles=[];
    try{ roles = JSON.parse(localStorage.getItem("roles")||"[]") }catch{}
    if (!roles.length){
      const pl=decodeJwtPayload(t)||{};
      if (Array.isArray(pl.roles)) roles=pl.roles;
      else if (Array.isArray(pl.authorities)) roles=pl.authorities;
      else if (typeof pl.scope==="string") roles=pl.scope.split(/\s+/);
      else if (typeof pl.role==="string") roles=[pl.role];
    }
    roles = roles.map(r => String(r).toUpperCase().replace(/^ROLE_/,""));
    if (!(roles.includes("ORGANIZER") || roles.includes("ADMIN"))){ location.href="/login.html"; return false; }
    return true;
  }

  // ώρα από διάφορα πεδία
  function extractTime(perf){
    const cands = [
      perf.scheduledTime, perf.performanceTime, perf.performanceDateTime,
      perf.startTime, perf.dateTime, perf.time, perf.timeSlot
    ].filter(Boolean);
    if ((!cands || !cands.length) && Array.isArray(perf.preferredPerformanceSlots) && perf.preferredPerformanceSlots.length){
      const sorted = [...perf.preferredPerformanceSlots].sort(); cands.push(sorted[0]);
    }
    const s = cands.find(v => typeof v === "string" && /^\d{4}-\d{2}-\d{2}T/.test(v)) || cands.find(v => typeof v === "string") || null;
    if (!s) return null;
    const first = String(s).split(/\s*-\s*/)[0];
    const d = new Date(first);
    return isNaN(d.getTime()) ? null : d;
  }

  async function apiJsonOrThrow(req){
    const res = await fetch(req);
    if (res.ok || res.status === 204) return null;
    let msg = `HTTP ${res.status}`;
    try {
      const data = await res.json();
      if (data?.message) msg += ` – ${data.message}`;
      else if (data?.error) msg += ` – ${data.error}`;
    } catch {}
    throw new Error(msg);
  }

  async function approvePerformance(id){
    const url = `${API_BASE}${PERF_PATH}/${id}/approve`;
    await apiJsonOrThrow(new Request(new URL(url, location.origin), {
      method: "POST",
      headers: {"Accept":"application/json", ...authHeader() },
      credentials: (location.origin === new URL(url, location.origin).origin ? "same-origin" : "omit")
    }));
    return true;
  }

  async function rejectPerformance(id, reason){
    const url = `${API_BASE}${PERF_PATH}/${id}/reject`;
    await apiJsonOrThrow(new Request(new URL(url, location.origin), {
      method: "POST",
      headers: {"Content-Type":"application/json","Accept":"application/json", ...authHeader() },
      body: JSON.stringify({reason}),
      credentials: (location.origin === new URL(url, location.origin).origin ? "same-origin" : "omit")
    }));
    return true;
  }

  // ====== List (ανθεκτικό σε /{status} ΚΑΙ ?status=) ======
  async function fetchList(){
    const q = $("#q").value.trim();
    const status = ($("#status").value || "ALL").toUpperCase();

    setMsg("Φόρτωση...", "");

    const params = new URLSearchParams();
    if (q) params.set("q", q);
    params.set("page","0");
    params.set("size","200");
    params.set("sort","createdAt,desc");

    const tries = (status !== "ALL")
      ? [
          `${API_BASE}${PERF_PATH}/${encodeURIComponent(status)}?${params.toString()}`, // /{STATUS}
          `${API_BASE}${PERF_PATH}?${new URLSearchParams({...Object.fromEntries(params), status}).toString()}`, // ?status=STATUS
        ]
      : [
          `${API_BASE}${PERF_PATH}?${new URLSearchParams({...Object.fromEntries(params), status:"ALL"}).toString()}`, // ?status=ALL
          `${API_BASE}${PERF_PATH}?${params.toString()}` // σκέτο pageable
        ];

    for (const u of tries){
      const uObj = new URL(u, location.origin);
      const res = await fetch(uObj, {
        headers: { ...authHeader() },
        credentials: (uObj.origin === location.origin ? "same-origin" : "omit")
      });
      if (!res.ok) continue;
      const ct = res.headers.get("content-type") || "";
      if (!ct.includes("application/json")) continue;
      const data = await res.json();
      const list =
        Array.isArray(data) ? data :
        Array.isArray(data?.content) ? data.content :
        Array.isArray(data?.items) ? data.items :
        Array.isArray(data?._embedded?.performances) ? data._embedded.performances :
        Array.isArray(data?.performances) ? data.performances : [];
      if (Array.isArray(list)) {
        setMsg(list.length ? "" : "Δεν βρέθηκαν παραστάσεις.", list.length ? "" : "error");
        return list;
      }
    }

    setMsg("Σφάλμα φόρτωσης ή άδειο αποτέλεσμα.","error");
    return [];
  }

  function card(perf){
    const idRaw = perf.id ?? perf.performanceId ?? perf.performanceID;
    const id = Number(idRaw);
    const validId = Number.isFinite(id);

    const title = perf.name || "Untitled";
    const artist = perf.mainArtist?.username || perf.mainArtist?.name || perf.artist || "—";
    const fest = perf.festival?.name || perf.festivalName || (perf.festivalId ? ("Festival #"+perf.festivalId) : "—");
    const when = extractTime(perf);
    const whenTxt = when ? new Intl.DateTimeFormat("el-GR",{dateStyle:"medium",timeStyle:"short"}).format(when) : "—";
    const status = String(perf.status||"").toUpperCase();

    const root = document.createElement("div");
    root.className = "card";
    root.innerHTML = `
      <h3>${escapeHtml(title)}</h3>
      <div class="meta">Καλλιτέχνης: ${escapeHtml(artist)}</div>
      <div class="meta">Φεστιβάλ: ${escapeHtml(fest)}</div>
      <div class="meta">Κατάσταση: <span class="badge">${escapeHtml(status)}</span></div>
      <div class="meta">Ώρα: <strong>${escapeHtml(whenTxt)}</strong></div>

      <details style="margin:.5rem 0">
        <summary class="small muted">Περισσότερα…</summary>
        <div class="meta">Είδος: ${escapeHtml(perf.genre || "—")}</div>
        <div class="meta">Διάρκεια: ${escapeHtml(perf.duration || perf.durationMinutes || "—")}</div>
        <div class="meta">Περιγραφή: ${escapeHtml(perf.description || "—")}</div>
      </details>

      <div class="row between" style="margin-top:.6rem; display:flex;">
        <div class="row" style="display:flex; gap:.5rem;">
          <button class="btn-approve">Approve</button>
          <button class="btn-reject">Reject</button>
        </div>
        <input type="text" class="reason" placeholder="Reason (για reject)" style="min-width:180px" />
      </div>

      <div class="msg small"></div>
    `;

    const msg = root.querySelector(".msg");
    const btnApprove = root.querySelector(".btn-approve");
    const btnReject = root.querySelector(".btn-reject");
    const reasonEl = root.querySelector(".reason");

    if (!validId){
      btnApprove.disabled = true;
      btnReject.disabled  = true;
      msg.textContent = "Invalid/missing ID";
      msg.className = "msg error";
    }

    btnApprove.addEventListener("click", async () => {
      btnApprove.disabled = btnReject.disabled = true;
      msg.textContent = "Έγκριση..."; msg.className="msg";
      try{
        await approvePerformance(id);
        msg.textContent = "OK: Approved."; msg.className="msg success";
        setTimeout(render, 600);
      }catch(e){
        msg.textContent = e.message || "Αποτυχία approve.";
        msg.className="msg error";
      }finally{
        btnApprove.disabled = btnReject.disabled = false;
      }
    });

    btnReject.addEventListener("click", async () => {
      const reason = reasonEl.value.trim();
      if (!reason){
        msg.textContent = "Δώσε reason για reject."; msg.className="msg error";
        return;
      }
      btnApprove.disabled = btnReject.disabled = true;
      msg.textContent = "Απόρριψη..."; msg.className="msg";
      try{
        await rejectPerformance(id, reason);
        msg.textContent = "OK: Rejected."; msg.className="msg success";
        setTimeout(render, 600);
      }catch(e){
        msg.textContent = e.message || "Αποτυχία reject.";
        msg.className="msg error";
      }finally{
        btnApprove.disabled = btnReject.disabled = false;
      }
    });

    return root;
  }

  async function render(){
    if (!ensureOrganizer()) return;
    const list = await fetchList();
    const host = $("#list");
    host.innerHTML = "";
    if (!list.length){ setMsg("Δεν βρέθηκαν παραστάσεις.","error"); return; }
    list.sort((a,b)=> {
      const ta=extractTime(a), tb=extractTime(b);
      if (ta && tb) return ta - tb;
      if (ta && !tb) return -1;
      if (!ta && tb) return 1;
      return String(a.name||"").localeCompare(String(b.name||""));
    });
    const frag = document.createDocumentFragment();
    list.forEach(p => frag.appendChild(card(p)));
    host.appendChild(frag);
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("#btn-load").addEventListener("click", render);
    $("#q").addEventListener("keydown", e => { if (e.key==="Enter") render(); });
    $("#btn-logout").addEventListener("click", () => {
      try { localStorage.removeItem("access_token"); localStorage.removeItem("roles"); } catch {}
      location.href="/login.html";
    });

    // ΝΕΟ: redirect στο festivals.html
    document.getElementById("btn-festivals")?.addEventListener("click", () => {
      window.location.href = "/festivals.html";
    });

    render();
  });
    </script>
  </body>
</html>
